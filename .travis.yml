dist: xenial
sudo: required
language: python
python:
  - "3.7"
cache:
  pip: true
env:
  - PANDIR=/var/huntsman POCS=${PANDIR}/POCS PANUSER=$USER HUNTSMAN_POCS=${PANDIR}/huntsman-pocs
before_install:
  # Set up directories.
  - sudo mkdir $PANDIR && sudo chmod 777 $PANDIR
  - mkdir -p $PANDIR/logs
  - ln -s $TRAVIS_BUILD_DIR $PANDIR/huntsman-pocs
  # Install testing dependencies.
  - pip install -U pip
  - pip install setuptools --upgrade
  - pip install coveralls
  - cd $PANDIR
  # Install panoptes-utils
  - git clone https://github.com/panoptes/panoptes-utils.git
  - cd panoptes-utils
  - pip install -Ur requirements.txt
  - python setup.py install
  # Install POCS
  - git clone https://github.com/panoptes/POCS.git
  - cd POCS
  - pip install -r requirements.txt
  - python setup.py install
  # Create SSH key for Pyro nameservers
  - ssh-keygen -b 2048 -t rsa -f ~/.ssh/id_rsa -N ''
  - touch ~/.ssh/authorized_keys
  - cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys
  - ssh-keyscan -H localhost >> ~/.ssh/known_hosts
addons:
  apt:
    packages:
      - sshfs
install:
  - cd $TRAVIS_BUILD_DIR
  - pip install -r requirements.txt
  - python -c "from astroplan import download_IERS_A; download_IERS_A()"
  - python setup.py install
before_script:
  - echo -e "Host 127.0.0.1\n\tStrictHostKeyChecking no\n" >> ~/.ssh/config
script:
  - export PYTHONPATH="$PYTHONPATH:$POCS/scripts/coverage"
  - export COVERAGE_PROCESS_START=.coveragerc
  - coverage run $(which pytest) -vrst
  - coverage combine
after_success:
  - bash <(curl -s https://codecov.io/bash)
